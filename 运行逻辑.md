# 运行逻辑

本文档说明本项目如何基于 Cloudflare Worker + D1 Database 实现计数与返回。

## 组成

- Worker 入口：[`index.js`](./index.js)
- D1 表结构：[`DB.sql`](./DB.sql)

Worker 依赖的绑定/变量：

- `DB`：D1 Database binding
- `SALT`：用于对 IP 做哈希
- `API_KEY`：用于 `/stats` 鉴权

## 数据表与口径

### visits（明细，90 天清理）

- 一次访问一行
- 用途：
  - `/stats` 实时统计按时间窗口 COUNT
  - 复核/排查

字段关键点：

- `visit_time`：毫秒时间戳
- `page_path`：规范化后的路径
- `ip_hash`：`SHA-256(ip + SALT)` 截断前 16 位 hex

### unique_visitors（永久 UV 去重集合）

- 主键 `ip_hash`
- 用途：判断某个访客是否首次出现

### global_stats（永久全站累计 PV/UV）

- 固定一行 `id = 1`
- 用途：
  - `/total` 返回全站永久累计 PV/UV
  - `/page-stats` 返回时附带全站永久累计 PV/UV

### page_stats（永久文章累计 PV）

- 主键 `page_path`
- 只对文章页累计（永久口径）
- 字段：
  - `total_visits`：文章累计 PV
  - `total_unique_visitors`：文章累计 UV

### page_unique_visitors（永久文章 UV 去重集合）

- 复合主键 `page_path + ip_hash`
- 用途：判断“某个访客是否首次访问某篇文章”，用于文章累计 UV

## Path 如何进入系统

所有涉及页面路径的接口都从 QueryString 的 `path` 读取，然后统一规范化：

- `normalizePagePath(input)` 会把输入转成 pathname
  - 支持 `path=/posts/a` 或 `path=posts/a`
  - 支持 `path=https://site.com/posts/a?x=1`
  - 统一补齐前导 `/`
  - 非根路径去掉尾部 `/`

文章页判定：

- `isPostPagePath(pagePath)` 使用正则严格匹配
  - `^/post/[A-Za-z0-9_-]+$`
  - `^/posts/[A-Za-z0-9_-]+$`

## 计数写入：/log

`/log` 是唯一的“写入入口”。每次调用会完成一次计数。

### 1) 白名单校验

`/log` 先校验来源域名：

- 优先读取请求头 `Origin`
- 没有则读取 `Referer` 的 origin
- 去 D1 的 `config.allowed_domains`（JSON 数组）判断是否允许，包含 `"*"` 表示全放行

不通过直接 `403`。

### 2) 生成 ip_hash

Worker 读取请求头 `CF-Connecting-IP`，与 `SALT` 拼接后做 SHA-256，截断得到短 hash 写入 `visits.ip_hash`。

### 3) 写 visits

插入一行：

- `visit_time = now`
- `page_path = normalizePagePath(path)`
- `ip_hash = hashIP(CF-Connecting-IP, SALT)`
- `user_agent / referer / country` 从请求头写入（有长度截断）

### 4) 永久 UV 去重：unique_visitors

执行：

- `INSERT OR IGNORE INTO unique_visitors (ip_hash, first_seen)`

如果本次插入发生（`meta.changes` 为真），说明是新增 UV。

### 5) 永久全站累计：global_stats

执行：

- `total_visits += 1`
- `total_unique_visitors += (是否新增 UV)`
- `last_updated = now`

这一步让 `/total` 和 `/page-stats` 可以不扫描明细表，直接返回全站永久累计。

### 6) 永久文章累计：page_stats（仅文章页）

当 `page_path` 命中文章页规则时，执行 UPSERT：

1) 文章 UV 去重：page_unique_visitors

- `INSERT OR IGNORE INTO page_unique_visitors (page_path, ip_hash, first_seen)`
- 如果本次插入发生（`meta.changes` 为真），说明是该文章新增 UV

2) 文章累计：page_stats

- 不存在则插入：`total_visits = 1`，`total_unique_visitors = (是否新增 UV)`
- 存在则更新：`total_visits += 1`，`total_unique_visitors += (是否新增 UV)`，并更新 `last_updated`

### 7) 返回

返回 1x1 透明 GIF（适合用像素上报）。

## 查询返回

### /total（全站永久累计）

返回数据来源：`global_stats`。

- 先查 Worker 边缘缓存 `caches.default`，命中直接返回
- 未命中则查询 D1：`SELECT total_visits, total_unique_visitors, last_updated FROM global_stats WHERE id = 1`
- 返回 JSON 并带 `Cache-Control: public, max-age=60`
- 异步把响应写入 `caches.default`

因此：`/total` 是永久累计口径，不依赖 `visits`。

### /page-stats（文章永久累计 + 全站永久累计）

返回数据来源：

- 文章累计：`page_stats`（按 `page_path` 查）
- 全站累计：`global_stats`（`id = 1`）

流程：

- 只允许 GET
- 白名单校验
- `path` 规范化后必须命中文章页规则，否则 `400`
- 分别查询 `page_stats` 与 `global_stats`，把字段合并后返回
- 文章累计字段：
  - `articleTotal`：文章累计 PV
  - `articleUnique`：文章累计 UV

### /stats（实时统计，窗口口径）

返回数据来源：`visits`。

鉴权：必须带 `Authorization: Bearer <API_KEY>`。

支持：

- `period=today`：`visit_time > 当天 00:00`
- `period=all`：扫描 `visits` 表内全部
- 可选 `path`：先规范化，再加上 `page_path = ?` 的过滤

计算方式：

- PV：`COUNT(*)`
- UV：`COUNT(DISTINCT ip_hash)`

注意：`visits` 会按 90 天清理，因此 `/stats` 只反映保留窗口内的数据。

## 定时清理

`scheduled()` 由 Cron Trigger 触发，执行：

- `DELETE FROM visits WHERE visit_time < now - 90天`

不会清理：`page_stats`、`page_unique_visitors`、`global_stats`、`unique_visitors`，因此这些口径是永久累计。
